<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuiz Interaktif UPKK 2024 - Adab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Naskh+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for Jawi text */
        .jawi {
            font-family: 'Noto Naskh Arabic', serif;
            direction: rtl;
            text-align: right;
            line-height: 2.2;
        }
        .question-card {
            transition: all 0.3s ease-in-out;
            border-left: 5px solid transparent;
        }
        .correct {
            background-color: #f0fdf4 !important;
            border-left-color: #22c55e !important;
        }
        .incorrect {
            background-color: #fef2f2 !important;
            border-left-color: #ef4444 !important;
        }
        .correct-answer-text {
            color: #16a34a;
        }
        .user-answer-text-incorrect {
            color: #dc2626;
            text-decoration: line-through;
        }
        .result-summary {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Ensure textarea for Rumi is LTR */
        .rumi-input {
            direction: ltr;
            text-align: left;
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-700">Kuiz Percubaan UPKK 2024</h1>
            <p class="text-xl text-blue-600 font-semibold">Mata Pelajaran: Adab</p>
        </header>

        <div id="quiz-container" class="space-y-6">
            <!-- Questions will be injected here by JavaScript -->
        </div>
        
        <div id="subjective-section" class="mt-8">
            <!-- Subjective questions will be here -->
        </div>

        <div class="mt-8 text-center">
            <button id="submit-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-blue-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                Hantar Jawapan
            </button>
        </div>

        <div id="results-container" class="hidden mt-10 p-6 bg-white rounded-xl shadow-lg result-summary">
            <h2 class="text-2xl font-bold text-center mb-4">Keputusan Anda</h2>
            <div class="text-center">
                <p class="text-lg">Skor Anda:</p>
                <p id="score" class="text-5xl font-bold text-blue-600 my-2">0 / 0</p>
                <p id="percentage" class="text-xl text-gray-600 font-semibold"></p>
                <p id="feedback-message" class="mt-4 text-lg font-medium"></p>
            </div>
            <div class="mt-8 text-center">
                <button id="retry-btn" class="bg-gray-700 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-gray-800 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-gray-300">
                    Cuba Lagi
                </button>
            </div>
        </div>

    </div>

    <div id="quiz-data-holder" style="display: none;"></div>
    <script>
        const quizData = [
             // BAHAGIAN A
            {
                section: 'Bahagian A: Soalan 1 (5 Markah)',
                questions: [
                    { type: 'mcq-inline', q: '١. ماءنسي دچيڤتا اوليه (الله / ملائكة).', options: ['الله', 'ملائكة'], answer: 'الله' },
                    { type: 'mcq-inline', q: '٢. ماكن ماكنن يڠ باءيق دان (حلال / حرام).', options: ['حلال', 'حرام'], answer: 'حلال' },
                    { type: 'mcq-inline', q: '٣. حكوم برادب دڠن ايبو باڤ اداله (سنة / واجب).', options: ['سنة', 'واجب'], answer: 'واجب' },
                    { type: 'mcq-inline', q: '٤. كيت هندقله مماكاي ڤاكاين يڠ (منوتوڤ / ممبوك) عورة.', options: ['منوتوڤ', 'ممبوك'], answer: 'منوتوڤ' },
                    { type: 'mcq-inline', q: '٥. سيتي ماسوق كتاندس دڠن كاكي (كانن / كيري) بسرتا دعاء.', options: ['كانن', 'كيري'], answer: 'كيري' }
                ]
            },
            {
                section: 'Bahagian A: Soalan 2 (5 Markah)',
                questions: [
                    { type: 'true-false', q: '١. نابيلا ممباچ دعاء سبلوم تيدور.', answer: 'Betul' },
                    { type: 'true-false', q: '٢. نوفل مينوم اءير سمبيل برديري.', answer: 'Salah' },
                    { type: 'true-false', q: '٣. الله سوك كڤد اورڠ يڠ بربوهوڠ.', answer: 'Salah' },
                    { type: 'true-false', q: '٤. سنتياس برصلوات كڤد رسول الله ﷺ.', answer: 'Betul' },
                    { type: 'true-false', q: '٥. عثمان ممينتا ايذين ايبوڽ سبلوم كلوار رومه.', answer: 'Betul' }
                ]
            },
            // BAHAGIAN B
            {
                section: 'Bahagian B (10 Markah)',
                questions: [
                    { type: 'mcq', q: '١. اڤاكه ڤركارا يڠ دلارڠ كتيك ددالم مسجد؟', options: {'ا': 'برسندو', 'ب': 'رامه مسرا', 'ج': 'ممبري سلام', 'د': 'منيڠڬيكن سوارا'}, answer: 'د' },
                    { type: 'mcq', q: '٢. سبلوم منزيارهي قبور كيت د_______ بروضوء.', options: {'ا': 'سنتكن', 'ب': 'واجبكن', 'ج': 'حرامكن', 'د': 'هاروسكن'}, answer: 'ا' },
                    { type: 'mcq', q: '٣. اورڠ يڠ تيدق مڠعملكن ادب برجالن اكن _______', options: {'ا': 'راماي كاون', 'ب': 'دليندوڠي الله', 'ج': 'تردده كڤد بهاي', 'د': 'سلامت دالم ڤرجالنن'}, answer: 'ج' },
                    { type: 'mcq', q: '٤. اڤاكه مقصود ساودارا - مارا؟', options: {'ا': 'جيرن', 'ب': 'راكن', 'ج': 'مشاركت', 'د': 'قوم كلوارڬ'}, answer: 'د' },
                    { type: 'mcq', q: '٥. ادب منزيارهي اورڠ ساكيت اياله _______', options: {'ا': 'بربوات بيسيڠ', 'ب': 'ڤرلاكوان بيادب', 'ج': 'وقتو تيدق سسواي', 'د': 'ممبري كات-كات سمangat'}, answer: 'د' },
                    { type: 'mcq', q: '٦. اڤاكه عاقبة درهاك كڤد اورڠ توا؟', options: {'ا': 'موره رزقي', 'ب': 'هيدوڤ بهاڬيا', 'ج': 'دموركاءي الله', 'د': 'برتمبه كاسيه سايڠ'}, answer: 'ج' },
                    { type: 'mcq', q: '٧. دعاء دأتس بركاءيتن دڠن ادب _______ <br> <span class="jawi text-xl">اللَّهُمَّ افْتَحْ لِي أَبْوَابَ رَحْمَتِكَ</span>', options: {'ا': 'ماكن', 'ب': 'برجالن', 'ج': 'برسوكن', 'د': 'ماسوق مسجد'}, answer: 'د' },
                    { type: 'mcq', q: '٨. برايكوت اداله فاءيده مڠعملكن ادب سبلوم تيدور كچوالي _______', options: {'ا': 'جيوا تيدق تنڠ', 'ب': 'ميندا منجادي چردس', 'ج': 'توبوه بادن منجادي صيحت', 'د': 'داڤت مڠعملكن سنة رسول الله'}, answer: 'ا' },
                    { type: 'mcq', q: '٩. اڤاكه كلبيهن مڠعملكن ادب كتيك ددالم مسجد؟', options: {'ا': 'دڤليهارا اوليه الله', 'ب': 'لالاي ملاكوكن عبادة', 'ج': 'مندوروڠ كڤد معصية', 'د': 'ڤوتوس هوبوڠن صلة الرحيم'}, answer: 'ا' },
                    { type: 'mcq', q: '١٠. اڤاكه لارڠن كتيك منزيارهي كماتين؟<br><span class="jawi block text-right text-base leading-relaxed">i. مراتقي كماتين<br>ii. مندعاءكن جنازه<br>iii. منونايكن صلاة جنازه<br>iv. باتس ڤرڬاولن تيدق دجاڬ</span>', options: {'ا': 'i dan ii', 'ب': 'ii dan iii', 'ج': 'iii dan iv', 'د': 'i dan iv'}, answer: 'د' }
                ]
            },
            // BAHAGIAN C
            {
                section: 'Bahagian C: Soalan 1 (5 Markah)',
                noQuestionShuffle: true,
                questions: [{
                    type: 'fill-blank',
                    q: `ايسي تمڤت كוסوڠ دڠن جواڤن يڠ دسدياكن.<br><br>
                        <div class="jawi text-lg leading-relaxed">هيدوڤ برجيرن مستي دعملكن دالم كهيدوڤن سهارين دان داڤت مڠرتكن (1) ________. عملن اين اكن داڤت ملاهيركن سواسان يڠ (2) ________ سرتا امت دسوكاءي اوليه الله دان (3) ________. سكيران semangat كجيرنن تيدق دعملكن، كيت سوكر منداڤتكن (4) ________ دان مشاركت اكن (5) ________.</div>`,
                    choices: ['صلة الرحيم', 'هرموني', 'رسول', 'فرتولوڠن', 'برڤچه بله'],
                    answers: ['صلة الرحيم', 'هرموني', 'رسول', 'فرتولوڠن', 'برڤچه بله']
                }]
            },
            {
                section: 'Bahagian C: Soalan 2 (10 Markah)',
                questions: [
                    { type: 'true-false', q: '١. برلمه لمبوت دالم ڤرڬاولن.', answer: 'Betul' },
                    { type: 'true-false', q: '٢. ممبري لاينن يڠ باءيق كڤد تتامو.', answer: 'Betul' },
                    { type: 'true-false', q: '٣. صالح ممبواڠ سمڤه دمراتا تمڤت.', answer: 'Salah' },
                    { type: 'true-false', q: '٤. علي ممبوات بيسيڠ درومه راكنڽ.', answer: 'Salah' },
                    { type: 'true-false', q: '٥. منجاڬ كسلامتن ديري دان هرتا.', answer: 'Betul' },
                    { type: 'true-false', q: '٦. هندقله بروضوء سبلوم ممڬڠ القرءان.', answer: 'Betul' },
                    { type: 'true-false', q: '٧. احمد منومڤوكن ڤرهاتين كتيك برمشوارت.', answer: 'Betul' },
                    { type: 'true-false', q: '٨. فاطمة منوتوڤ عورة كتيك منزيارهي قبور ايبوڽ.', answer: 'Betul' },
                    { type: 'true-false', q: '٩. سيتي ممباچ بوكو چريتا كتيك ڬورو سدڠ مڠاجر.', answer: 'Salah' },
                    { type: 'true-false', q: '١٠. عمر برماسم موك دڠن ساودارا-مارا يڠ داتڠ كرومهڽ.', answer: 'Salah' }
                ]
            },
            {
                section: 'Bahagian C: Soalan 3 (5 Markah)',
                noQuestionShuffle: true,
                questions: [{
                    type: 'matching',
                    q: 'ڤادنكن ڤرڽاتاءن بهاڬين (i) دڠن ڤرڽاتاءن بهاڬين (ii).',
                    pairs: [
                        { item: '١. منڤتي ماس', answer: 'ادب كتيك برمشوارت' },
                        { item: '٢. برماءين تيليفون', answer: 'لارڠن كتيك برمشوارت' },
                        { item: '٣. منومڤوكن ڤرهاتين', answer: 'ادب كتيك برمشوارت' },
                        { item: '٤. ممبري ڤنداڤت يڠ برنس', answer: 'ادب كتيك برمشوارت' },
                        { item: '٥. منيمبولكن سواسان تڬڠ', answer: 'لارڠن كتيك برمشوارت' }
                    ],
                    choices: ['ادب كتيك برمشوارت', 'لارڠن كتيك برمشوارت']
                }]
            },
             {
                section: 'Bahagian C: Soalan 4 (5 Markah)',
                questions: [
                    { type: 'mcq-inline', q: '١. مڠوچڤكن (تهنيئه / تعزيه) كڤد كلوارڬ سي ماتي.', options: ['تهنيئه', 'تعزيه'], answer: 'تعزيه' },
                    { type: 'mcq-inline', q: '٢. برچاكڤ دڠن (كاسر / سوڤن) دڠن اورڠ ديواس.', options: ['كاسر', 'سوڤن'], answer: 'سوڤن' },
                    { type: 'mcq-inline', q: '٣. كيت هندقله (منجاڬ / مڠابايكن) كبرسيهن تانه ڤرقبورن.', options: ['منجاڬ', 'مڠابايكن'], answer: 'منجاڬ' },
                    { type: 'mcq-inline', q: '٤. ممباوا (بواه تاڠن / بواه مولوت) كتيك منزيارهي اورڠ ساكيت.', options: ['بواه تاڠن', 'بواه مولوت'], answer: 'بواه تاڠن' },
                    { type: 'mcq-inline', q: '٥. كيت ڤرلو مڠهيدڠ ماكنن مڠڬوناكن ڤيڠڬن مڠكوق يڠ (برجنما / برسيه).', options: ['برجنما', 'برسيه'], answer: 'برسيه' }
                ]
            },
            {
                section: 'Bahagian C: Soalan 5 (5 Markah)',
                questions: [{
                    type: 'categorize',
                    q: 'ايسي ڤرڽاتاءن دباوه مڠيكوت ادب دان لارڠن كتيك منزيارهي كماتين.',
                    items: ['دودوق دڠن ترتيب', 'مراتقي كماتين', 'تندا ڤڠحرمتن تراخير', 'بربوات بيسيڠ دان برماءين', 'مندعاءكن سي ماتي'],
                    categories: [
                        { name: 'ادب منزيارهي كماتين', items: ['دودوق دڠن ترتيب', 'تندا ڤڠحرمتن تراخير', 'مندعاءكن سي ماتي'] },
                        { name: 'لارڠن منزيارهي كماتين', items: ['مراتقي كماتين', 'بربوات بيسيڠ دان برماءين'] }
                    ]
                }]
            }
        ];
        
        const subjectiveData = [
            {
                section: 'Bahagian D (Soalan Subjektif - Semakan Kendiri)',
                note: 'Bahagian ini tidak dikira dalam pemarkahan automatik. Sila bandingkan jawapan anda dengan cadangan jawapan yang diberikan selepas kuiz.',
                questions: [
                    { 
                        q: '١. توليس دوا ادب دڠن اورڠ توا.', 
                        a: 'i. Lemah lembut / Memberi salam<br>ii. Merendah diri / Bercakap dengan sopan' 
                    },
                    { 
                        q: '٢. برداسركن سيتواسي "احمد مپدياكن ماكنن كڤد اورڠ يڠ داتڠ"، جلسكن دوا فاءيده برادب دڠن تتامو.', 
                        a: 'i. Dimurahkan rezeki / Disukai masyarakat<br>ii. Mengukuhkan perpaduan masyarakat' 
                    },
                    { 
                        q: '٣. برداسركن سيتواسي "علي مڠحضيري مجليس هاري لاهير راكنڽ"، هورايكن دوا فاءيده ڤربواتن ترسبوت.', 
                        a: 'i. Dapat kenalan baru / Mengeratkan silaturahim<br>ii. Terhindar daripada permusuhan' 
                    },
                    { 
                        q: '٤. سنارايكن دوا چونتوه ميديا سوسيال.', 
                        a: 'i. TikTok<br>ii. Youtube / Facebook (Mana-mana jawapan yang sesuai)' 
                    },
                    {
                        q: '٥. برداسركن سيتواسي "سلمى برچاكڤ دڠن سوارا يڠ كاسر كڤد داتوقڽ"، توليس دوا عاقبة درڤد ڤربواتن ترسبوت.',
                        a: 'i. Hubungan menjadi renggang<br>ii. Dimurkai Allah'
                    },
                    {
                        q: '٦. توليسكن دوا ادب كتيك مڠڬوناكن ميديا سوسيال.',
                        a: 'i. Menjaga batas pergaulan<br>ii. Menjadi pendengar yang baik'
                    },
                    {
                        q: '٧. جلسكن دوا كلبيهن مڠعملكن ادب كتيك صلاة جمعة.',
                        a: 'i. Mengeratkan silaturahim dengan jemaah yang lain<br>ii. Dapat memahami isi khutbah dengan baik'
                    }
                ]
            }
        ];


        const quizContainer = document.getElementById('quiz-container');
        const subjectiveContainer = document.getElementById('subjective-section');
        const submitBtn = document.getElementById('submit-btn');
        const resultsContainer = document.getElementById('results-container');
        const scoreEl = document.getElementById('score');
        const percentageEl = document.getElementById('percentage');
        const feedbackMessageEl = document.getElementById('feedback-message');
        const retryBtn = document.getElementById('retry-btn');
        
        let totalScore = 0;

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function renderQuiz() {
            quizContainer.innerHTML = '';
            totalScore = 0;
            let questionIndex = 0;
            
            const shuffledQuizData = JSON.parse(JSON.stringify(quizData));
            shuffledQuizData.forEach(sectionData => {
                if (!sectionData.noQuestionShuffle) {
                    sectionData.questions = shuffleArray(sectionData.questions);
                }
            });

            shuffledQuizData.forEach((sectionData) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'mb-6';

                const sectionTitle = document.createElement('h2');
                sectionTitle.className = 'text-xl font-bold mb-4 p-3 bg-blue-100 text-blue-800 rounded-lg';
                sectionTitle.textContent = sectionData.section;
                sectionDiv.appendChild(sectionTitle);

                const questionsWrapper = document.createElement('div');
                questionsWrapper.className = 'space-y-4';

                sectionData.questions.forEach((qData) => {
                    const questionCard = document.createElement('div');
                    questionCard.className = 'bg-white p-5 rounded-lg shadow-sm question-card';
                    questionCard.setAttribute('data-question-id', questionIndex);
                    
                    const questionText = document.createElement('div');
                    questionText.className = 'jawi text-lg font-medium mb-4';
                    questionText.innerHTML = qData.q;
                    questionCard.appendChild(questionText);

                    const answerArea = document.createElement('div');
                    answerArea.className = 'space-y-2';
                    
                    switch (qData.type) {
                        case 'mcq-inline':
                            totalScore++;
                            const shuffledMcqInlineOptions = shuffleArray(qData.options);
                            shuffledMcqInlineOptions.forEach(opt => {
                                const label = document.createElement('label');
                                label.className = 'flex items-center space-x-3 p-3 rounded-md hover:bg-gray-50 cursor-pointer';
                                label.innerHTML = `
                                    <input type="radio" name="q${questionIndex}" value="${opt}" class="form-radio h-5 w-5 text-blue-600">
                                    <span class="jawi text-lg">${opt}</span>
                                `;
                                answerArea.appendChild(label);
                            });
                            break;
                        case 'true-false':
                             totalScore++;
                             const shuffledTfOptions = shuffleArray(['Betul', 'Salah']);
                             shuffledTfOptions.forEach(opt => {
                                const label = document.createElement('label');
                                label.className = 'flex items-center space-x-3 p-3 rounded-md hover:bg-gray-50 cursor-pointer';
                                label.innerHTML = `
                                    <input type="radio" name="q${questionIndex}" value="${opt}" class="form-radio h-5 w-5 text-blue-600">
                                    <span>${opt}</span>
                                `;
                                answerArea.appendChild(label);
                            });
                            break;
                         case 'mcq':
                            totalScore++;
                            const shuffledMcqOptions = shuffleArray(Object.entries(qData.options));
                            shuffledMcqOptions.forEach(([key, value]) => {
                                const label = document.createElement('label');
                                label.className = 'flex items-center space-x-3 p-3 rounded-md hover:bg-gray-50 cursor-pointer';
                                label.innerHTML = `
                                    <input type="radio" name="q${questionIndex}" value="${key}" class="form-radio h-5 w-5 text-blue-600">
                                    <span class="jawi text-lg">${key}. ${value}</span>
                                `;
                                answerArea.appendChild(label);
                            });
                            break;
                        case 'fill-blank':
                            totalScore += qData.answers.length;
                            const shuffledFillBlankChoices = shuffleArray(qData.choices);
                            qData.answers.forEach((ans, i) => {
                                const itemDiv = document.createElement('div');
                                itemDiv.className = 'flex items-center gap-4';
                                itemDiv.innerHTML = `<span class="jawi font-semibold text-gray-700">(${i + 1})</span>`;
                                const select = document.createElement('select');
                                select.name = `q${questionIndex}_${i}`;
                                select.className = 'jawi block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500';
                                const defaultOption = document.createElement('option');
                                defaultOption.value = "";
                                defaultOption.textContent = "Pilih Jawapan";
                                select.appendChild(defaultOption);
                                shuffledFillBlankChoices.forEach(choice => {
                                    const option = document.createElement('option');
                                    option.value = choice;
                                    option.textContent = choice;
                                    select.appendChild(option);
                                });
                                itemDiv.appendChild(select);
                                answerArea.appendChild(itemDiv);
                            });
                            break;
                        case 'matching':
                             totalScore += qData.pairs.length;
                             const shuffledMatchingChoices = shuffleArray(qData.choices);
                             qData.pairs.forEach((pair, i) => {
                                const itemDiv = document.createElement('div');
                                itemDiv.className = 'grid grid-cols-2 gap-4 items-center';
                                itemDiv.innerHTML = `<p class="jawi text-lg text-right">${pair.item}</p>`;
                                const select = document.createElement('select');
                                select.name = `q${questionIndex}_${i}`;
                                select.className = 'jawi block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500';
                                const defaultOption = document.createElement('option');
                                defaultOption.value = "";
                                defaultOption.textContent = "Pilih Padanan";
                                select.appendChild(defaultOption);
                                shuffledMatchingChoices.forEach(choice => {
                                    const option = document.createElement('option');
                                    option.value = choice;
                                    option.textContent = choice;
                                    select.appendChild(option);
                                });
                                itemDiv.appendChild(select);
                                answerArea.appendChild(itemDiv);
                             });
                            break;
                        case 'categorize':
                             totalScore += qData.items.length;
                             const shuffledCategorizeItems = shuffleArray(qData.items);
                             qData.items = shuffledCategorizeItems;
                             shuffledCategorizeItems.forEach((item, i) => {
                                const itemDiv = document.createElement('div');
                                itemDiv.className = 'grid grid-cols-2 gap-4 items-center';
                                itemDiv.innerHTML = `<p class="jawi text-lg text-right">${item}</p>`;
                                const select = document.createElement('select');
                                select.name = `q${questionIndex}_${i}`;
                                select.className = 'jawi block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500';
                                const defaultOption = document.createElement('option');
                                defaultOption.value = "";
                                defaultOption.textContent = "Pilih Kategori";
                                select.appendChild(defaultOption);
                                qData.categories.forEach(cat => {
                                    const option = document.createElement('option');
                                    option.value = cat.name;
                                    option.textContent = cat.name;
                                    select.appendChild(option);
                                });
                                itemDiv.appendChild(select);
                                answerArea.appendChild(itemDiv);
                             });
                            break;
                    }
                    
                    questionCard.appendChild(answerArea);
                    const feedbackDiv = document.createElement('div');
                    feedbackDiv.className = 'mt-4 text-sm font-semibold hidden';
                    feedbackDiv.id = `feedback-${questionIndex}`;
                    questionCard.appendChild(feedbackDiv);
                    questionsWrapper.appendChild(questionCard);

                    questionIndex++;
                });
                sectionDiv.appendChild(questionsWrapper);
                quizContainer.appendChild(sectionDiv);
            });
            document.getElementById('quiz-data-holder').textContent = JSON.stringify(shuffledQuizData);
        }
        
        function renderSubjectiveSection(showAnswers = false) {
            subjectiveContainer.innerHTML = '';
            subjectiveData.forEach(sectionData => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'mb-6';
                const sectionTitle = document.createElement('h2');
                sectionTitle.className = 'text-xl font-bold mb-4 p-3 bg-gray-100 text-gray-800 rounded-lg';
                sectionTitle.textContent = sectionData.section;
                sectionDiv.appendChild(sectionTitle);
                const note = document.createElement('p');
                note.className = 'italic text-gray-600 mb-4';
                note.textContent = sectionData.note;
                sectionDiv.appendChild(note);
                const questionsWrapper = document.createElement('div');
                questionsWrapper.className = 'space-y-4';
                sectionData.questions.forEach((q) => {
                    const qCard = document.createElement('div');
                    qCard.className = 'bg-white p-5 rounded-lg shadow-sm';
                    const qText = document.createElement('p');
                    qText.className = 'jawi text-lg font-medium';
                    qText.textContent = q.q;
                    qCard.appendChild(qText);
                    if(showAnswers) {
                        const answerDiv = document.createElement('div');
                        answerDiv.className = 'mt-3 pt-3 border-t border-dashed';
                        answerDiv.innerHTML = `<p class="text-sm font-semibold text-blue-700">Cadangan Jawapan:</p><div class="text-gray-800">${q.a}</div>`;
                        qCard.appendChild(answerDiv);
                    } else {
                        const textArea = document.createElement('textarea');
                        textArea.rows = 3;
                        textArea.className = 'rumi-input mt-2 w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500';
                        textArea.placeholder = 'Tulis jawapan anda di sini (Tulisan Rumi diterima).';
                        qCard.appendChild(textArea);
                    }
                    questionsWrapper.appendChild(qCard);
                });
                sectionDiv.appendChild(questionsWrapper);
                subjectiveContainer.appendChild(sectionDiv);
            });
        }
        
        function calculateScoreLogic(renderedData) {
            let currentScore = 0;
            let currentQuestionId = 0;
            
            renderedData.forEach((sectionData) => {
                sectionData.questions.forEach((qData) => {
                    const questionCard = document.querySelector(`[data-question-id="${currentQuestionId}"]`);
                    const feedbackDiv = document.getElementById(`feedback-${currentQuestionId}`);
                    feedbackDiv.innerHTML = '';
                    feedbackDiv.classList.remove('hidden');

                    let isCorrect = true;

                    switch (qData.type) {
                        case 'mcq-inline':
                        case 'true-false':
                        case 'mcq':
                            const userAnswer = document.querySelector(`input[name="q${currentQuestionId}"]:checked`);
                            if (userAnswer) {
                                if (userAnswer.value === qData.answer) {
                                    currentScore++;
                                    questionCard.classList.add('correct');
                                } else {
                                    questionCard.classList.add('incorrect');
                                    feedbackDiv.innerHTML = `<span class="correct-answer-text jawi">Jawapan Betul: ${qData.answer}</span> | <span class="user-answer-text-incorrect jawi">Jawapan Anda: ${userAnswer.value}</span>`;
                                }
                            } else {
                                questionCard.classList.add('incorrect');
                                feedbackDiv.innerHTML = `<span class="correct-answer-text jawi">Jawapan Betul: ${qData.answer}</span><br><span>Anda tidak menjawab soalan ini.</span>`;
                            }
                            break;
                        
                        case 'fill-blank':
                             qData.answers.forEach((ans, i) => {
                                const select = document.querySelector(`select[name="q${currentQuestionId}_${i}"]`);
                                if (select && select.value === ans) {
                                    currentScore++;
                                    select.classList.add('border-green-500', 'ring-green-500');
                                } else {
                                    isCorrect = false;
                                    select.classList.add('border-red-500', 'ring-red-500');
                                }
                             });
                             if (!isCorrect) {
                                 questionCard.classList.add('incorrect');
                                 feedbackDiv.innerHTML = `<span class="correct-answer-text jawi">Jawapan Betul: ${qData.answers.join(', ')}</span>`;
                             } else {
                                 questionCard.classList.add('correct');
                             }
                            break;
                        
                        case 'matching':
                            qData.pairs.forEach((pair, i) => {
                                const select = document.querySelector(`select[name="q${currentQuestionId}_${i}"]`);
                                if (select && select.value === pair.answer) {
                                    currentScore++;
                                    select.classList.add('border-green-500', 'ring-green-500');
                                } else {
                                    isCorrect = false;
                                    select.classList.add('border-red-500', 'ring-red-500');
                                }
                            });
                             if (isCorrect) {
                                 questionCard.classList.add('correct');
                             } else {
                                 questionCard.classList.add('incorrect');
                                 feedbackDiv.innerHTML = `<span class="correct-answer-text">Sila rujuk jawapan yang betul.</span>`;
                             }
                            break;

                        case 'categorize':
                            qData.items.forEach((item, i) => {
                                const select = document.querySelector(`select[name="q${currentQuestionId}_${i}"]`);
                                const originalItemData = quizData.flatMap(s => s.questions).find(q => q.type === 'categorize').items;
                                const originalCategories = quizData.flatMap(s => s.questions).find(q => q.type === 'categorize').categories;
                                const correctAnswer = originalCategories.find(cat => cat.items.includes(item)).name;
                                if (select && select.value === correctAnswer) {
                                    currentScore++;
                                    select.classList.add('border-green-500', 'ring-green-500');
                                } else {
                                    isCorrect = false;
                                    select.classList.add('border-red-500', 'ring-red-500');
                                }
                            });
                             if (isCorrect) {
                                 questionCard.classList.add('correct');
                             } else {
                                 questionCard.classList.add('incorrect');
                                 feedbackDiv.innerHTML = `<span class="correct-answer-text">Sila rujuk jawapan yang betul.</span>`;
                             }
                            break;
                    }
                    currentQuestionId++;
                });
            });

            scoreEl.textContent = `${currentScore} / ${totalScore}`;
            const percentage = totalScore > 0 ? Math.round((currentScore / totalScore) * 100) : 0;
            percentageEl.textContent = `${percentage}%`;
            
            if (percentage >= 80) {
                feedbackMessageEl.textContent = 'Cemerlang! Usaha yang sangat baik!';
                feedbackMessageEl.className = 'mt-4 text-lg font-medium text-green-600';
            } else if (percentage >= 50) {
                feedbackMessageEl.textContent = 'Baik! Teruskan usaha anda!';
                feedbackMessageEl.className = 'mt-4 text-lg font-medium text-yellow-600';
            } else {
                feedbackMessageEl.textContent = 'Jangan putus asa, cuba lagi untuk lebih faham!';
                feedbackMessageEl.className = 'mt-4 text-lg font-medium text-red-600';
            }
            
            resultsContainer.classList.remove('hidden');
            submitBtn.classList.add('hidden');
            document.querySelectorAll('input, select').forEach(el => el.disabled = true);
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            
            renderSubjectiveSection(true);
        }

        submitBtn.addEventListener('click', () => {
            try {
                const renderedData = JSON.parse(document.getElementById('quiz-data-holder').textContent);
                calculateScoreLogic(renderedData);
            } catch(e) {
                console.error("Gagal memproses data kuiz:", e);
                alert("Terdapat ralat teknikal. Sila muat semula halaman dan cuba lagi.");
            }
        });

        retryBtn.addEventListener('click', () => {
            resultsContainer.classList.add('hidden');
            submitBtn.classList.remove('hidden');
            renderQuiz(); 
            renderSubjectiveSection(false);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Initial render
        renderQuiz();
        renderSubjectiveSection(false);

    </script>
</body>
</html>

